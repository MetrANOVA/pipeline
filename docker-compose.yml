version: '3.8'

services:

  pipeline:
    image: metranova/pipeline:latest
    build:
      context: .
      dockerfile: Dockerfile
    env_file:
      - envs/base.env
      - ${PIPELINE_ENV_FILE:-.env}
    volumes:
      - ./certificates:/app/certificates:ro
      - ./caches:/app/caches:rw
      - ./pipelines:/app/pipelines:ro
      - ./conf:/etc/metranova_pipeline:ro
    restart: always
    deploy:
      mode: replicated
      replicas: ${PIPELINE_REPLICAS:-1}

  redis:
    image: redis:8.2.1
    ports:
      - "6379:6379"